<!DOCTYPE html>
<html>
  <head>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Emoji:wght@300..700&family=Noto+Sans+Arabic:wght@100..900&family=Noto+Sans+Cuneiform&family=Noto+Sans+Devanagari:wght@100..900&family=Noto+Sans+Egyptian+Hieroglyphs&family=Noto+Sans+Mayan+Numerals&family=Noto+Sans+Old+Persian&family=Noto+Sans+Symbols+2&family=Noto+Sans:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Sets</title>
    <style>
.page-controls {
  display: inline-flex;
  flex-direction: column;
  width: 2.4em;
  gap: 0.4em;
}
body {
  height: 100%;
  margin: 0;
  display: flex;
  flex-direction: column;
  background: #222;
  color: #aaa;
  font-family: "Noto Sans", sans-serif;
  font-size: 1.4em;
}
h1 {
  font-size: 1em;
  text-align: center;
}
button,select {
  border-radius: 6px;
}
button {
  user-select: none;
}
button:enabled {
  cursor: pointer;
}
a {
  color: inherit;
  text-decoration: none;
}

button {
  height: 3em;
}
select {
  cursor: pointer;
}
option {
  cursor: pointer;
}
.symbols {
  height: 3em
}
.system {
  height: 3em
}

.page-controls * {
  margin: 0.1em;
}
.page {
  display: inline-block;
  text-align: center;
  width: 100%;
}
.row {
  font-size: 0.8em;
  text-align: right;
}
.row a {
  padding: 0.3em;
  border: thin solid #fff0;
  border-radius: 0.4em;
}
.selected a {
  font-weight: bold;
  border: thin solid #fff8;
  background: #fff1;
}

.num {
  white-space: pre;
  text-wrap: nowrap;
  display: inline-block;
  line-height: 1em;
  margin: 0;
}

.leds .num {
  font-size: 1.4em;
  line-height: 0.2em;
}
.mayan a {
  display: inline-block;
}
.apples .num {
  font-family: "Noto Emoji", sans-serif;
  font-size: 0.8em;
}
.babylonian .num {
  font-family: "Noto Sans Cuneiform", "Noto Sans Old Persian", sans-serif;
}
.devanagari .num {
  font-family: "Noto Sans Devanagari", sans-serif;
}
.egyptian .num {
  font-family: "Noto Sans Egyptian Hieroglyphs", sans-serif;
  line-height: 0.1em;
  font-size: 1.8em;
}
.egyptian .title .num {
  font-size: 1em;
}
.fence .num {
  font-family: "Noto Sans Symbols 2", sans-serif;
  font-size: 1em;
}
.mashriq .num {
  font-family: "Noto Sans Arabic", sans-serif;
}
.mayan .num {
  font-family: "Noto Sans Mayan Numerals", sans-serif;
  font-size: 1.6em;
  line-height: 0.8em;
}
.mayan .info .num {
  font-size: 1em;
}
.rods .num {
  font-family: "Noto Sans Symbols 2", sans-serif;
}
.trigrams .num {
  font-size: 1.8em;
  line-height: 1.2em;
}
.zheng .num {
  font-family: "Noto Sans Symbols 2", sans-serif;
  font-size: 1em;
}

.info {
  border: 2px solid #fff0;
  border-width: 2px 0 0 0;
  background: #000d;
  color: #fffe;
  position: fixed;
  right: 0;
  bottom: 0;
  left: 0;
  min-height: 0;
  max-height: 0;
  border-radius: 40px 40px 0 0;
  text-align: center;
  z-index: 2;
}

.info .body {
  display: flex;
  flex-direction: column;
  padding: 1em;
}

.open {
  border: 2px solid #fff4;
  border-width: 2px 0 0 0;
  min-height: 40%;
  max-height: 95%;
}

.info .close {
  font-family: "Noto Sans Symbols 2", sans-serif;
  color: #fffa;
  position: absolute;
  top: 0.3em;
  right: 1em;
  font-size: 1.2em;
}

.info .close:hover {
  color: #fffd;
}

.info .title {
  text-align: left;
  font-weight: bold;
  font-size: 1.2em;
  max-width: 75%;
  padding: 0.6em 1em 0.2em 5%;
  overflow: hidden;
  text-overflow: ellipsis;
}

.info hr {
  margin: 0.2em 5% 0.2em 5%;
}

.info .label {
  margin: 1.4em 0 0.6em 0;
  font-size: 0.6em;
}

.info .vector {
  margin: 1.4em 0;
  line-height: 1.4em;
}

.info .compo {
  font-weight: normal;
  color: #fffa;
}

.info .mults {
  font-weight: normal;
  color: #fffa;
}

.js-info {
  display: contents;
}
.js-examples {
  display: contents;
}
.main {
    width: 100svw;
    height: 100svh;
    overflow: hidden;
  display: grid;
  gap: 0.8em;
  grid-template-columns: 0 1fr 0;
  grid-template-rows: 0 auto minmax(0, 1fr) 0;
  grid-template-areas:
    "top top top"
    "left header right"
    "left examples right"
    "bot bot bot"
}
.navigation {
  grid-area: header;
  display: flex;
  flex-direction: row;
  justify-content: space-between;
  z-index: 1;
}
.examples {
  padding: 1em;
  background: #262626;
  grid-area: examples;
  min-width: 1em;
  overflow: auto;
  display: grid;
  grid-auto-columns: minmax(0, 1fr);
  grid-auto-rows: minmax(0, 1fr);
  justify-items: left;
  align-items: center;
}
.mayan .examples {
  grid-auto-rows: initial;
  overflow: auto;
}


@media screen and (min-width: 800px) {

  .close {
    display: none;
  }
  .mayan .close {
    display: none;
  }
  .main {
    gap: 1em;
    grid-template-columns: 0 1fr 1fr 0;
    grid-template-areas:
      "top top top top"
      "left examples header right"
      "left examples info info"
      "bot bot bot bot"
  }
  .info {
    position: initial;
    grid-area: info;
    align-self: start;
    min-height: 20em;
    max-height: 95%;
    border-width: 2px 0 2px 2px;
    border-radius: 40px 0 0 40px;
  }
}


.c0 { width: 10% }
.c1 { width: 20% }
.c2 { width: 35% }
.c3 { width: 55% }
.c4 { width: 75% }
.c5 { width: 95% }

.apples .row,.babylonian .row,.egyptian .row,.fence .row,.roman .row,.zheng .row {
  text-align: left;
}

.apples .c0,.babylonian .c0,.egyptian .c0,.fence .c0,.roman .c0,.zheng .c0 { width: auto; margin-left: 0; }
.apples .c1,.babylonian .c1,.egyptian .c1,.fence .c1,.roman .c1,.zheng .c1 { width: auto; margin-left: 5%; }
.apples .c2,.babylonian .c2,.egyptian .c2,.fence .c2,.roman .c2,.zheng .c2 { width: auto; margin-left: 10%; }
.apples .c3,.babylonian .c3,.egyptian .c3,.fence .c3,.roman .c3,.zheng .c3 { width: auto; margin-left: 15%; }
.apples .c4,.babylonian .c4,.egyptian .c4,.fence .c4,.roman .c4,.zheng .c4 { width: auto; margin-left: 25%; }
.apples .c5,.babylonian .c5,.egyptian .c5,.fence .c5,.roman .c5,.zheng .c5 { width: auto; margin-left: 40%; }

/*
.d0 { background: #fac }
.d1 { background: #fca }
.d2 { background: #afc }
.d3 { background: #cfa }
.d4 { background: #acf }
.d5 { background: #edf }
*/

.colorize .d { color: #edf }
.colorize .d0 { color: #fac }
.colorize .d1 { color: #fca }
.colorize .d2 { color: #afc }
.colorize .d3 { color: #cfa }
.colorize .d4 { color: #acf }
.colorize .d5 { color: #edf }

select option.default {
  font-weight: bold;

}
    </style>
    <script>

const SDW = '\u{103d0}' // slanted double wedge seems to be missing from unicode

const ii = (fe) => fe()

function fromGen(g) {
  const xs = []
  for (x of g()) {
    xs.push(x)
  }
  return xs
}

function* ints() {
  let i = 0
  while(true) {
    yield i
    i += 1
  }
}

const map = (g, f) => function* () {
  for (const x of g()) {
    yield f(x)
  }
}

const concat = (...gs) => function* () {
  for (const g of gs) {
    for (const x of g()) {
      yield x
    }
  }
}

const take = (g, c) => function* () {
  let i = 0
  for (const x of g()) {
    if (i >= c) {
      return
    }
    yield x
    i += 1
  }
}

const drop = (g, c) => function* () {
  let i = 0
  for (const x of g()) {
    if (i >= c) {
      yield x
    }
    i += 1
  }
}

const systems = {
  apples: {
    title: 'Apples',
    main: 'tally',
    tally: 1,
    symbols: [,'\u{1f34e}\ufe0e'],
    safe: 'js-tally',
  },
  babylonian: {
    main: 'base-60',
    tally: 1,
    symbols: ii(() => {
      const U = [
        '',
        '\u{1230b}',
        '\u{12399}',
        '\u{1230d}',
        '\u{1240f}',
        '\u{12410}',
      ]
      const DISH = [
        '',
        '\u{12079}',
        '\u{1222b}',
        '\u{12408}',
        '\u{12409}',
        '\u{1240a}',
        '\u{1240b}',
        '\u{1240c}',
        '\u{1240d}',
        '\u{1240e}',
      ]
      return U.flatMap((u) => DISH.map((d) => u + d || SDW))
    }),
  },
  devanagari: {
    title: 'Devanagari',
    main: 'base-10',
    tally: 1,
    bases: [10],
    symbols: [
      '\u{0966}',
      '\u{0967}',
      '\u{0968}',
      '\u{0969}',
      '\u{096a}',
      '\u{096b}',
      '\u{096c}',
      '\u{096d}',
      '\u{096e}',
      '\u{096f}',
    ],
  },
  egyptian: {
    title: 'Egyptian',
    main: 'add',
    symbols: {
      '\u{13068}': 1_000_000,
      '\u{13190}':   100_000,
      '\u{130b5}':    90_000,
      '\u{130b4}':    80_000,
      '\u{130b3}':    70_000,
      '\u{130b2}':    60_000,
      '\u{130b1}':    50_000,
      '\u{130b0}':    40_000,
      '\u{130af}':    30_000,
      '\u{130ae}':    20_000,
      '\u{130ad}':    10_000,
      '\u{131c4}':     9_000,
      '\u{131c3}':     8_000,
      '\u{131c2}':     7_000,
      '\u{131c1}':     6_000,
      '\u{131c0}':     5_000,
      '\u{131bf}':     4_000,
      '\u{131be}':     3_000,
      '\u{131bd}':     2_000,
      '\u{131bc}':     1_000,
      '\u{1336a}':       900,
      '\u{13369}':       800,
      '\u{13368}':       700,
      '\u{13367}':       600,
      '\u{13366}':       500,
      '\u{13365}':       400,
      '\u{13364}':       300,
      '\u{13363}':       200,
      '\u{13362}':       100,
      '\u{1338e}':        90,
      '\u{1338d}':        80,
      '\u{1338c}':        70,
      '\u{1338b}':        60,
      '\u{1338a}':        50,
      '\u{13389}':        40,
      '\u{13388}':        30,
      '\u{13387}':        20,
      '\u{13386}':        10,
      '\u{13402}':         9,
      '\u{13401}':         8,
      '\u{13400}':         7,
      '\u{133ff}':         6,
      '\u{133fe}':         5,
      '\u{133fd}':         4,
      '\u{133fc}':         3,
      '\u{133fb}':         2,
      '\u{133fa}':         1,
    },
    safe: 'js-egyptian',
  },
  fence: {
    title: 'Fence',
    main: 'tally',
    tally: 5,
    symbols: {
      '\u{1d378}': 5,
      '\u{1d377}\u{1d377}\u{1d377}\u{1d377}': 4,
      '\u{1d377}\u{1d377}\u{1d377}': 3,
      '\u{1d377}\u{1d377}': 2,
      '\u{1d377}': 1,
    }
  },
  leds: {
    title: 'LEDs',
    main: 'base-2',
    tally: 1,
    symbols: [
      '\u25cb',
      '\u25cf',
    ],
  },
  mayan: {
    title: 'Mayan',
    main: 'base-20',
    tally: 1,
    symbols: [
      '\u{1d2e0}',
      '\u{1d2e1}',
      '\u{1d2e2}',
      '\u{1d2e3}',
      '\u{1d2e4}',
      '\u{1d2e5}',
      '\u{1d2e6}',
      '\u{1d2e7}',
      '\u{1d2e8}',
      '\u{1d2e9}',
      '\u{1d2ea}',
      '\u{1d2eb}',
      '\u{1d2ec}',
      '\u{1d2ed}',
      '\u{1d2ee}',
      '\u{1d2ef}',
      '\u{1d2f0}',
      '\u{1d2f1}',
      '\u{1d2f2}',
      '\u{1d2f3}',
    ],
  },
  mashriq: {
    title: 'Mashriq',
    main: 'base-10',
    tally: 1,
    bases: [10],
    symbols: [
      '\u{0660}',
      '\u{0661}',
      '\u{0662}',
      '\u{0663}',
      '\u{0664}',
      '\u{0665}',
      '\u{0666}',
      '\u{0667}',
      '\u{0668}',
      '\u{0669}',
    ],
  },
  rods: {
    title: 'Rods',
    main: 'base-10',
    tally: 5,
    symbols: [
      '\u3007',
      '\u{1d360}',
      '\u{1d361}',
      '\u{1d362}',
      '\u{1d363}',
      '\u{1d364}',
      '\u{1d365}',
      '\u{1d366}',
      '\u{1d367}',
      '\u{1d368}',
    ],
    evenSymbols: [
      '\u3007',
      '\u{1d369}',
      '\u{1d36a}',
      '\u{1d36b}',
      '\u{1d36c}',
      '\u{1d36d}',
      '\u{1d36e}',
      '\u{1d36f}',
      '\u{1d370}',
      '\u{1d371}',
    ],
    bases: [10],
  },
  roman: {
    title: 'Roman',
    main: 'add',
    symbols: ii(() => {

      const M = 1000
      const D = 500
      const C = 100
      const L = 50
      const X = 10
      const V = 5
      const I = 1

      const CM = M - C
      const CD = D - C
      const XC = C - X
      const XL = L - X
      const IX = X - I
      const IV = V - I

      return { M, CM, D, CD, C, XC, L, XL, X, IX, V, IV, I }

    }),
    safe: 'js-roman',
  },
  thai: {
    title: 'Thai',
    main: 'base-10',
    tally: 1,
    symbols: ['\u{0e50}', '\u{0e51}', '\u{0e52}', '\u{0e53}', '\u{0e54}', '\u{0e55}', '\u{0e56}', '\u{0e57}', '\u{0e58}', '\u{0e59}'],
  },
  latin: {
    title: 'Latin',
    main: 'base-10',
    tally: 1,
    symbols: fromGen(concat(take(ints, 10), take(map(drop(ints, 0x41), (c) => String.fromCharCode(c)), 26)))
,
    bases: [2, 8, 10, 16, 36],
  },
  zheng: {
    title: 'Zhèng',
    main: 'tally',
    tally: 5,
    bases: [],
    symbols: {
      '\u{1d376}': 5,
      '\u{1d375}': 4,
      '\u{1d374}': 3,
      '\u{1d373}': 2,
      '\u{1d372}': 1,
    },
  },
}

const lowerLimit = (x) => Math.pow(2, Math.floor(Math.log2(x)))
const upperLimit = (x) => Math.pow(2, Math.ceil(Math.log2(x)))

const MIN = 2 ** 12
const MAX = 2 ** 13
const WIDTH = 6
const COLS = 6

const chars = {
  dot: '\u22c5',
  mul: '\u00d7',

}

const toString = (g, d = ', ') => {
  let str = ''
  for (x of g()) {
    str += d + x
  }
  return str.slice(d.length)
}

const logG = (g) => console.log(toString(g))

const log = (x) => { console.log(x); return x }

const fromArray = (xs) => function* () {
  for (x in xs) {
    yield x
  }
}

const empty = function* () {}

const of = (x) => function* () { yield x }

const chunkify = (g, c) => function* () {
  let xs = []
  for (x of g()) {
    if (xs.length >= x) {
      yield xs
      xs = []
    }
    xs.push(x)
  }
  yield xs
}

const flatten = (gs) => function* () {
  for (const g of gs()) {
    for (const x of g()) {
      yield x
    }
  }
}

const flatMap = (g, f) => flatten(map(g, f))

const filter = (g, f) => function* () {
  for (const x of g()) {
    if (f(x)) {
      yield x
    }
  }
}

const takeWhile = (g, f) => function* () {
  for (const x of g()) {
    if (!f(x)) {
      return
    }
    yield x
  }
}

const dropWhile = (g, f) => function* () {
  let done = false
  for (const x of g()) {
    if (!done) {
      done = !f(x)
    }
    if (done) {
      yield x
    }
  }
}

const zip = (g1, g2) => function* () {
  const i1 = g1()
  const i2 = g2()
  while (true) {
    const r1 = i1.next()
    const r2 = i2.next()
    if (r1.done || r2.done) {
      return
    }
    yield [r1.value, r2.value]
  }
}

const pairs = (g) => zip(g, drop(g, 1))

const pow2s = map(ints, (x) => 2 ** x)

const half = ([a, b]) => {
  const r = a + Math.floor((b - a) / 2)
  return (r === a || r === b) ? empty : of(r)
}

const both = ([a, b]) => concat(of(a), half([a, b]))
const boths = (g) => flatMap(pairs(g), both)

const fulls = (g, i = 1) => i < 1 ? g : fulls(boths(g), i - 1)
const halfs = (g) => flatMap(pairs(g), half)

const distance = (i) => {
  if (i < 1) {
    return pow2s
  }
  return halfs(fulls(pow2s, i - 1))
}

const groupDigits = (str, x) => {
  if (str.length <= x) {
    return str
  }
  return groupDigits(str.slice(0, 0 - x), x) + '\u2009' + str.slice(0 - x)
}

const repeatG = (str, x) => map(take(ints, x), () => str)

const repeat = (str, x) => fromGen(repeatG(str, x))

const fromSeed = (x, f) => function*() {
  let tmp = x
  while (true) {
    yield tmp
    tmp = f(tmp)
  }
}

const digits = (x, base) => map(takeWhile(fromSeed(x, (y) => Math.floor(y / base)), (d) => d > 0), (y) => y % base)

const getBase = (x, oddSymbols, evenSymbols = oddSymbols) => fromGen(digits(x, oddSymbols.length)).reverse().map((d, i, ds) => {
  return (ds.length - i) % 2 ? oddSymbols[d] : evenSymbols[d]
})

const skim = (x, lookup) => function* () {
  let tmp = x
  for (const [k, v] of Object.entries(lookup)) {
    while (tmp >= v) {
      yield k
      tmp -= v
    }
  }
}

/*
const trigrams = (x) => x.toString(8).split('').map((c) => {
  switch(c) {
    case '0': return '\u2637'
    case '1': return '\u2636'
    case '2': return '\u2635'
    case '3': return '\u2634'
    case '4': return '\u2633'
    case '5': return '\u2632'
    case '6': return '\u2631'
    case '7': return '\u2630'
  }
  return c
}).join('')
*/

const stringify = (x) => {
  switch(state.symbols) {
    case 'apples':
      return repeat(systems.apples.symbols[1], x).join('')
    case 'babylonian':
      const tmp = getBase(x, systems.babylonian.symbols)
      const spaces = []
      while (tmp.at(-1) === SDW) {
        tmp.pop()
        spaces.push('\u2003')
      }
      return [...tmp, ...spaces].join('\u2007')
    case 'devanagari':
      return getBase(x, systems.devanagari.symbols).join('')
    case 'egyptian':
      return fromGen(skim(x, systems.egyptian.symbols)).join('')
    case 'fence':
      return fromGen(skim(x, systems.fence.symbols)).join('')
    case 'latin':
      const [_b, b] = state.system.split('-')
      if (b < 2) {
        return repeat(1, x).join('')
      }
      const symbols = systems.latin.symbols.slice(0, b)
      return groupDigits(getBase(x, symbols).join(''), b === '10' ? 3 : 4)
    case 'leds':
      return getBase(x, systems.leds.symbols).join('')
    case 'mashriq':
      return getBase(x, systems.mashriq.symbols).join('')
    case 'mayan':
      return getBase(x, systems.mayan.symbols).join('\n')
    case 'rods':
      return getBase(x, systems.rods.symbols, systems.rods.evenSymbols).join('')
    case 'roman':
      return fromGen(skim(x, systems.roman.symbols)).join('')
    case 'thai':
      return getBase(x, systems.thai.symbols).join('')
    case 'zheng':
      return fromGen(skim(x, systems.zheng.symbols)).join('')
  }
  return x
}


const sample = (min, max) => (i) => map(takeWhile(dropWhile(distance(i), (y) => y < min), (x) => x <= max), (x) => [x, i])

const subDigits = [0x2080, 0x2081, 0x2082, 0x2083, 0x2084, 0x2085, 0x2086, 0x2087, 0x2088, 0x2089].map((c) => String.fromCharCode(c))

const superDigits = [0x2070, 0x00B9, 0x00B2, 0x00B3, 0x2074, 0x2075, 0x2076, 0x2077, 0x2078, 0x2079].map((c) => String.fromCharCode(c))

const toSubscript = (int) => int.toString().split('').map((d) => subDigits[d]).join('')
const toSuperscript = (int) => int.toString().split('').map((d) => superDigits[d]).join('')

const makeTitle = (i) => `D${toSubscript(i)}`
const leftSpaces = (str) => str.length - str.trimStart().length


const group = (buf) => function* () {
  let xs = []
  for (const x of buf) {
    if (xs.length < 1 || x === xs.at(-1)) {
      xs.push(x)
    } else {
      yield xs
      xs = [x]
    }
  }
  if (xs.length > 0) {
    yield xs
  }
}

const navigate = (s) => {
  if (s.hasOwnProperty('selected') && s.selected !== state.selected) {
    if (worker) {
      worker.terminate()
    }
    worker = multWorker()
    worker.onmessage = ({ data }) => {
      const { buf } = JSON.parse(data)
      state.mults = fromGen(group(buf))
      Array.from(document.getElementsByClassName('js-mults')).forEach(renderMults)
    }
    worker.postMessage(s.selected)
  }
  Array.from(document.getElementsByClassName('js-root')).forEach((elem) => {
    elem.setAttribute('class', 'js-root ' + (s.symbols ?? state.symbols))
  })
  Array.from(document.getElementsByClassName('js-system')).forEach((elem) => {
    if ('symbols' in s) {
      const noSys = document.getElementById('no-system')
      switch(s.symbols) {
        case 'babylonian': noSys.innerHTML = 'Base 60'; break;
        case 'devanagari': noSys.innerHTML = 'Base 10'; break;
        case 'mashriq': noSys.innerHTML = 'Base 10'; break;
        case 'mayan': noSys.innerHTML = 'Base 20'; break;
        case 'rods': noSys.innerHTML = 'Base 10'; break;
        case 'thai': noSys.innerHTML = 'Base 10'; break;
        default: noSys.innerHTML = 'Additive';
      }
      if (s.symbols === 'latin') {
        if (state.symbols !== 'latin') {
          elem.selectedIndex = 5
        }
        noSys.setAttribute('hidden', 'hidden')
        elem.removeAttribute('disabled')
      } else {
        elem.setAttribute('disabled', 'disabled')
        noSys.removeAttribute('hidden')
        elem.selectedIndex = 0
      }
    }
  })
  Object.entries(s).forEach(([k, v]) => {
    state[k] = v
  })
  console.log('navigate', state)
  render()
}

const isPrime = (x) => {
  const upper = Math.sqrt(x)
  const divs = fromGen(filter(takeWhile(drop(ints, 2), (i) => i <= upper), (d) => x % d === 0))
  return divs.length < 1
}

const divisors = (x) => filter(takeWhile(drop(ints, 1), (i) => i <= x), (d) => x % d === 0)

const divPairs = (x) => map(divisors(x), (d) => [d, x / d])

const renderExamples = (min, max) => (elem) => {
  const lines = fromGen(flatMap(take(ints, COLS), sample(min, max))).sort(([a], [b]) => (a - b)).map(([a, b]) => {
    const line = document.createElement('div')
    line.setAttribute('class', 'row c' + b + (state.selected === a ? ' selected' : '' ))
    const link = document.createElement('a')
    line.appendChild(link)
    link.setAttribute('href', '#')
    link.addEventListener('click', (event) => {
      event.preventDefault()
      navigate({ selected: a })
    })
    const num = document.createElement('span')
    num.setAttribute('class', 'num d d' + b)

    stringify(a).split('\u2007').forEach((part, i) => {
      if (i > 0) {
        const space = document.createTextNode('\u2007')
        num.appendChild(space)
      }
      const cell = document.createElement('span')
      cell.setAttribute('class', 'num_cell')
      cell.innerHTML = part
      num.appendChild(cell)
    })

    link.appendChild(num)
    return line
  })
  //const title = fromGen(map(take(ints, COLS), (i) => (makeTitle(i)).padStart(WIDTH))).join('')
  const body = document.createElement('div')
  body.setAttribute('class', 'examples colorize')
  //p.innerHTML = title + '\n\n' + lines.join('\n') + '\n\n' + title
  lines.forEach((line) => body.appendChild(line))
  elem.replaceChildren(body)
}

const dyads = (x) => {
  if (x < 1) {
    return []
  }
  const pow = Math.floor(Math.log2(x))
  return [['+', pow], ...dyads(x - 2 ** pow)]
}

const isOdd = (x) => Boolean(x % 2)

const rnaf = (x) => {
  if (x < 1) {
    return []
  }
  const digit = isOdd(x) ? 2 - (x % 4) : 0
  const sign = digit < 1 ? '-' : '+'
  return [[sign, Math.abs(digit)], ...rnaf((x - digit) / 2)]
}
const naf = (x) => rnaf(x).reverse()

const _components = (current, goal, step) => {
  if (current > goal) {
    return [['-', Math.log2(step)], ..._components(current - step, goal, step / 2)]
  }
  if (current < goal) {
    return [['+', Math.log2(step)], ..._components(current + step, goal, step / 2)]
  }
  return []
}
const components = (x) => {
  const lower = lowerLimit(x)
  if (lower === x) {
    return [['+', Math.log2(x)]]
  }
  return [['+', Math.log2(lower)], ..._components(lower, x, lower / 2)]
}
const dist = (x) => x < 1 ? null : components(x).length - 1

const _path = (current, goal, step) => {
  if (current > goal) {
    return [[current - step], ..._path(current - step, goal, step / 2)]
  }
  if (current < goal) {
    return [[current + step], ..._path(current + step, goal, step / 2)]
  }
  return []
}
const path = (x) => {
  const lower = lowerLimit(x)
  if (lower === x) {
    return [x]
  }
  return [lower, ..._path(lower, x, lower / 2)].flat()
}

const state = {
  page: 0,
  selected: null,
  mults: [],
  symbols: 'latin',
  system: 'base-10',
}

const strMult = (a, b) => a + '\xa0\u00d7\xa0' + b

const uniq = (xs) => Array.from(new Set(xs))

const makeWorker = (code) =>
  new Worker(URL.createObjectURL(new Blob([code], { type: 'application/javascript' })))

const multWorker = () => makeWorker(`

  const drop = ${drop}
  const ints = ${ints}
  const takeWhile = ${takeWhile}

  self.onmessage = function({ data: x }) {
    let prev = ''
    let tmp = x
    const buf = []
    const limit = Math.ceil(Math.sqrt(x))
    const g = takeWhile(drop(ints, 2), (i) => i <= limit)
    for (const a of g()) {
      while (tmp % a === 0) {
        buf.push(a)
        tmp /= a
      }
      if (tmp === 1) {
        break
      }
      const update = JSON.stringify({ buf, tmp, progress: ((a / limit) * 100).toPrecision(3) })
      if (update !== prev) {
        self.postMessage(update)
        prev = update
      }
    }
    if (tmp > 1) {
      buf.push(tmp)
    }
    self.postMessage(JSON.stringify({ buf, tmp, progress: null }))
  };
`)

let worker = null;

const renderInfoTitle = (selected) => (elem) => {
  const parts = path(selected)
  const title = document.createElement('div')
  title.setAttribute('class', 'title')
  const num = document.createElement('span')
  num.setAttribute('class', 'num d' + dist(selected))
  num.innerHTML = stringify(selected)
  title.appendChild(num)
  const sets = document.createElement('span')
  sets.setAttribute('class', 'title-sets')
  sets.innerHTML = ' \u220a '
  const distSet = document.createElement('span')
  distSet.innerHTML = '\u2192'
  const setNum = document.createElement('span')
  const dNum = parts.length - 1
  setNum.setAttribute('class', 'd' + dist(dNum) )
  setNum.innerHTML = toSubscript(dNum)
  distSet.appendChild(setNum)
  sets.appendChild(distSet )
  title.appendChild(sets)
  elem.appendChild(title)
}

const renderInfoVector = (selected) => (elem) => {
  const parts = path(selected)
  const vector = document.createElement('div')
  vector.setAttribute('class', 'vector colorize')
  const bob = (x) => stringify(x)
  parts.map(bob).forEach((x, i) => {
    if (i > 0) {
      const arrow = document.createTextNode('\xa0\u2192 ')
      vector.appendChild(arrow)
    }
    const part = document.createElement('span')
    part.setAttribute('class', 'num d d' + i)
    part.innerHTML = x
    vector.appendChild(part)
  })
  elem.appendChild(vector)
}

const renderInfoDyads = (selected) => (elem) => {
  const compo = document.createElement('div')
  compo.setAttribute('class', 'compo')
  dyads(selected).forEach(([s, n], i) => {
    if (i > 0) {
      const sign = document.createElement('span')
      sign.innerHTML = ` ${s === '-' ? '\u2212' : s} `
      compo.append(sign)
    }
    const two = document.createElement('span')
    two.setAttribute('class', 'num d' + dist(2))
    const pow = document.createElement('span')
    pow.setAttribute('class', 'd' + dist(n))
    two.innerHTML = stringify(2)
    pow.innerHTML = toSuperscript(n)
    compo.append(two)
    compo.append(pow)
  })
  elem.appendChild(compo)
}

const renderInfoNAF = (selected) => (elem) => {
  const compo = document.createElement('div')
  compo.setAttribute('class', 'compo')
  naf(selected).forEach(([s, n], i, nafs) => {
    if (n > 0) {
      if (i > 0) {
        const sign = document.createElement('span')
        sign.innerHTML = ` ${s === '-' ? '\u2212' : s} `
        compo.append(sign)
      }
      const two = document.createElement('span')
      two.setAttribute('class', 'num d' + dist(2))
      const pow = document.createElement('span')
      pow.setAttribute('class', 'd' + dist(n))
      two.innerHTML = stringify(2)
      pow.innerHTML = toSuperscript(nafs.length - 1 - i)
      compo.append(two)
      compo.append(pow)
    }
  })
  elem.appendChild(compo)
}

const renderInfoCompo = (selected) => (elem) => {
  const compo = document.createElement('div')
  compo.setAttribute('class', 'compo')
  components(selected).forEach(([s, n], i) => {
    if (i > 0) {
      const sign = document.createElement('span')
      sign.innerHTML = ` ${s === '-' ? '\u2212' : s} `
      compo.append(sign)
    }
    const two = document.createElement('span')
    two.setAttribute('class', 'num d' + dist(2))
    const pow = document.createElement('span')
    pow.setAttribute('class', 'd' + dist(n))
    two.innerHTML = stringify(2)
    pow.innerHTML = toSuperscript(n)
    compo.append(two)
    compo.append(pow)
  })
  elem.appendChild(compo)
}

const renderInfoMults = (selected) => (elem) => {
  const mults = document.createElement('div')
  mults.innerHTML = 'prime decomposition: '
  mults.setAttribute('class', 'mults js-mults')
  renderMults(mults)
  elem.appendChild(mults)
}

const renderInfoField = (labelText, renderChild) => (elem) => {
  const label = document.createElement('div')
  label.setAttribute('class', 'label')
  label.innerHTML = labelText
  elem.appendChild(label)
  renderChild(elem)
}

const renderInfo = (selected) => (elem) => {
  const info = document.createElement('div')
  if (selected === null) {
    info.setAttribute('class', 'info')
    elem.replaceChildren(info)
    return
  }
  info.setAttribute('class', 'info open')
  const parts = path(selected)

  const close = document.createElement('a')
  close.setAttribute('class', 'close')
  close.setAttribute('href', '#')
  close.addEventListener('click', (event) => {
    event.preventDefault()
    navigate({ selected: null })
  })
  close.innerHTML = '\u{1f5d9}'
  info.appendChild(close)

  const hr = document.createElement('hr')

  renderInfoTitle(selected)(info)
  info.appendChild(hr)
  const body = document.createElement('div')
  body.setAttribute('class', 'body')
  renderInfoField('Prime Decomposition', renderInfoMults(selected))(body)
  renderInfoField('Non-Adjacent Form', renderInfoNAF(selected))(body)
  renderInfoField('Dyadic Decomposition', renderInfoDyads(selected))(body)
  renderInfoField('\u201cGapless\u201d Dyadic Decomposition', (elem) => {
    renderInfoCompo(selected)(elem)
    renderInfoVector(selected)(elem)
  })(body)

  info.appendChild(body)
  elem.replaceChildren(info)
}

const renderMults = (elem) => {
  if (!state.mults?.length) {
    elem.innerHTML = '-'
    return
  }
  elem.innerHTML = ''
  state.mults.forEach((xs, i) => {
    if (i > 0) {
      const sign = document.createElement('span')
      sign.innerHTML = ' \u00d7 '
      elem.appendChild(sign)
    }
    const mult = document.createElement('span')
    mult.setAttribute('class', 'num d' + dist(xs.at(0)))
    mult.innerHTML = stringify(xs.at(0))
    elem.appendChild(mult)
    if (xs.length > 1) {
      const pow = document.createElement('span')
      pow.setAttribute('class', 'd' + dist(xs.length))
      pow.innerHTML = toSuperscript(xs.length)
      elem.appendChild(pow)
    }
  })
}

const renderControls = (panel) => {
  Array.from(panel.getElementsByClassName('home')).forEach((element) => {
    if (state.page === 0) {
      element.setAttribute('disabled',  'disabled')
    } else {
      element.removeAttribute('disabled')
    }
  })
  Array.from(panel.getElementsByClassName('prev')).forEach((element) => {
    if (state.page === 0) {
      element.setAttribute('disabled',  'disabled')
    } else {
      element.removeAttribute('disabled')
    }
  })
  Array.from(panel.getElementsByClassName('js-tally')).forEach((element) => {
    if (state.page > 2) {
      element.setAttribute('disabled',  'disabled')
    } else {
      element.removeAttribute('disabled')
    }
  })
  Array.from(panel.getElementsByClassName('js-roman')).forEach((element) => {
    if (state.page > 10) {
      element.setAttribute('disabled',  'disabled')
    } else {
      element.removeAttribute('disabled')
    }
  })
  Array.from(panel.getElementsByClassName('js-egyptian')).forEach((element) => {
    if (state.page > 20) {
      element.setAttribute('disabled',  'disabled')
    } else {
      element.removeAttribute('disabled')
    }
  })
}

const renderPage = (doc) => {
  const { page, selected } = state
  const min = 2 ** (page === 0 ? 0 : page + 4)
  const max = 2 ** (page === 0 ? 5 : page + 5)
  Array.from(doc.getElementsByClassName('js-examples')).forEach(renderExamples(min, max))
  Array.from(doc.getElementsByClassName('js-info')).forEach(renderInfo(selected))
  Array.from(doc.getElementsByClassName('js-controls')).forEach(renderControls)
}

const render = () => {
  renderPage(document)
}

const modifyPage = (x) => {
  state.page += x
  if (state.page < 0) {
    state.page = 0
  }
  render()
}

const home = () => {
  state.page = 0
  state.selected = null
  render()
}

const next = () => {
  modifyPage(1)
}

const prev = () => {
  modifyPage(-1)
}

const initKeyHandler = () => {
  addEventListener('keydown', (event) => {
    if (['Home'].includes(event.code)) { home() }
    if (['PageUp', 'KeyK'].includes(event.code)) { prev() }
    if (['PageDown', 'KeyJ'].includes(event.code)) { next() }
  })
}

const initClickHandlers = () => {
  Array.from(document.getElementsByClassName('prev')).forEach((element) => {
    element.addEventListener('click', (event) => {
      event.preventDefault()
      prev()
    })
  })
  Array.from(document.getElementsByClassName('next')).forEach((element) => {
    element.addEventListener('click', (event) => {
      event.preventDefault()
      next()
    })
  })
  Array.from(document.getElementsByClassName('home')).forEach((element) => {
    element.addEventListener('click', (event) => {
      event.preventDefault()
      home()
    })
  })
  Array.from(document.getElementsByClassName('js-symbols')).forEach((element) => {
    element.addEventListener('change', (event) => {
      event.preventDefault()
      navigate({ symbols: event.target.value })
    })
  })
  Array.from(document.getElementsByClassName('js-system')).forEach((element) => {
    element.addEventListener('change', (event) => {
      event.preventDefault()
      navigate({ system: event.target.value })
    })
  })
}

const initScroller = () => {
  scroll()
}

const init = () => {
  initKeyHandler()
  initClickHandlers()
  initScroller()
  navigate({ selected: null })
}

addEventListener('DOMContentLoaded', init)
    </script>
  </head>
  <body class="js-root">
    <div class="main">
      <div class="navigation js-controls">
        <div>
          <button class="home">Home</button>
        </div>
        <div>
          <select id="symbols" class="symbols js-symbols">
            <option value="apples" class="js-tally">Apples</option>
            <option value="babylonian">Babylonian</option>
            <option value="devanagari">Devanagari</option>
            <option value="egyptian" class="js-egyptian">Egyptian</option>
            <option value="fence" class="js-tally">Fence</option>
            <option value="latin" selected class="default">Latin</option>
            <option value="leds">LEDs</option>
            <option value="mashriq">Mashriq</option>
            <option value="mayan">Mayan</option>
            <option value="rods">Rods</option>
            <option value="roman" class="js-roman">Roman</option>
            <option value="thai">Thai</option>
            <!-- <option value="trigrams">Trigrams base 8</option> -->
            <option value="zheng" class="js-tally">Zhèng</option>
          </select>
          <select id="system" class="system js-system">
            <option id="no-system" value="" selected hidden></option>
            <option value="tally-1">Tally 1</option>
            <option value="base-2">Base 2</option>
            <option value="base-6">Base 6</option>
            <option value="base-8">Base 8</option>
            <option value="base-10" selected class="default">Base 10</option>
            <option value="base-16">Base 16</option>
            <option value="base-20">Base 20</option>
            <option value="base-36">Base 36</option>
          </select>
        </div>
        <div class="page-controls">
          <button class="prev">PgUp</button>
          <button class="next">PgDn</button>
        </div>
      </div>
      <div class="js-examples"></div>
      <div class="js-info"></div>
    </div>
  </body>
</html>
